# GitHub Actions Workflow for building Tiny11 Core ISO
# Author: kelexine (https://github.com/kelexine)
# Description: Fully automated Windows 11 Core ISO processing with tiny11coremaker
# Repository: https://github.com/kelexine/tiny11-automated

name: Build and Release Tiny11 Core

on:
  workflow_dispatch:
    inputs:
      windows_version:
        description: 'Windows version (e.g., 24H2, 25H2)'
        required: false
        default: '25H2'
      windows_iso_url:
        description: 'Windows 11 ISO download URL'
        required: true
        default: 'https://software.download.prss.microsoft.com/dbazure/Win11_25H2_English_x64.iso?t=84586cf6-9b51-4717-9c9e-43a147d13a76&P1=1765723100&P2=601&P3=2&P4=i01rQ%2fmrl%2buVppty0J5Sz%2fJ%2bagMP6ntwQbEymbF3T4N%2bBq%2fRQTaW6Ei%2fa%2fXNhGswmzAOOcPaTghphTtFMF0EX7U14aQxP%2fz%2bkgwKiCxLkH7ozABPxZyqf2SimL4OEhpOaR5BaeuOEvyLpFbk1NCf%2bK8xQqKQCvKIjqFJY7hgjkxWtuDIxsTMRZz5gXxmnStihqqgOYo%2fBkwQp7tMrn8V%2bQrWo9OrFMWyCUWMY2imfKCi5q0VFKhgBki52qhTJbxVR3IUsGgyXw2Xzk5DjJQ906IBtpTl3h7vSEDDw714sziwq0yMwdpN2WHbjZVt5mcqaYdg1GoWdM9xK6kL7tT6Tw%3d%3d'
      image_index:
        description: 'Windows image index (1=Home, 4=Education, 6=Pro, 7=Pro N)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '4'
          - '6'
          - '7'
      language:
        description: 'Language (e.g., English, Spanish, French)'
        required: false
        default: 'English'
      skip_cleanup:
        description: 'Skip cleanup (for debugging)'
        required: false
        default: false
        type: boolean
      enable_dotnet35:
        description: 'Enable .NET Framework 3.5'
        type: boolean
        required: false
        default: false

env:
  ARIA2C_CONNECTIONS: '16'
  ARIA2C_SPLIT: '16'
  POWERSHELL_TELEMETRY_OPTOUT: '1'

jobs:
  build-tiny11-core:
    runs-on: windows-latest
    timeout-minutes: 480
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate release tag and ISO name
        shell: powershell
        run: |
          # Get date for tag and ISO naming
          $date = Get-Date -Format 'yyyy-MM-dd'
          $version = "${{ github.event.inputs.windows_version }}"

          # Get edition based on index
          $index = "${{ github.event.inputs.image_index }}"
          $editions = @{
              "1" = "Home"
              "4" = "Education"
              "6" = "Pro"
              "7" = "ProN"
          }
          $edition = $editions[$index]

          $language = "${{ github.event.inputs.language }}" -replace '[^a-zA-Z]', ''

          # Generate tag and names - New structure: Tiny11Core-EDITION-VERSION for folders
          $folderName = "Tiny11Core-$edition-$version"
          $isoName = "Tiny11Core-$version-$language-$edition-$date.iso"

          # For GitHub releases, we'll use a more specific tag with date
          $baseTag = "tiny11core-$version-$date"

          # Check if tag already exists
          $existingTags = $(git tag -l "$baseTag*" | Measure-Object).Count
          if ($existingTags -gt 0) {
              $baseTag = "$baseTag-$($existingTags + 1)"
          }

          Write-Output "Generated tag: $baseTag"
          Write-Output "Generated ISO name: $isoName"
          Write-Output "Generated folder name: $folderName"

          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_TAG=$baseTag"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_FILENAME=$isoName"
          Add-Content -Path $env:GITHUB_ENV -Value "FOLDER_NAME=$folderName"

      - name: System information
        shell: powershell
        run: |
          Write-Output "=== System Information (Tiny11 Core Build) ==="
          Write-Output "OS: $(Get-CimInstance Win32_OperatingSystem | Select-Object -ExpandProperty Caption)"
          Write-Output "PowerShell: $($PSVersionTable.PSVersion)"
          Write-Output "Architecture: $env:PROCESSOR_ARCHITECTURE"

          $disk = Get-PSDrive C
          $freeGB = [math]::Round($disk.Free / 1GB, 2)
          $totalGB = [math]::Round($disk.Used / 1GB + $disk.Free / 1GB, 2)
          Write-Output "Disk C: ${freeGB}GB free / ${totalGB}GB total"

          if ($freeGB -lt 25) {
            Write-Error "Insufficient disk space. At least 25GB required for Core build, found ${freeGB}GB"
            exit 1
          }

      - name: Install aria2c
        shell: powershell
        run: |
          Write-Output "Installing aria2c for faster downloads..."
          choco install aria2 -y --no-progress
          aria2c --version

      - name: Display build warnings
        shell: powershell
        run: |
          Write-Output "=== TINY11 CORE BUILD WARNINGS ==="
          Write-Output ""
          Write-Output "WARNING: You are building a Tiny11 CORE image!"
          Write-Output ""
          Write-Output "This build is NOT suitable for:"
          Write-Output "  - Daily use as a primary OS"
          Write-Output "  - Systems requiring Windows Updates"
          Write-Output "  - Adding features or languages post-install"
          Write-Output "  - Production environments"
          Write-Output ""
          Write-Output "This build IS suitable for:"
          Write-Output "  - VM testing and development"
          Write-Output "  - Minimal Windows 11 evaluation"
          Write-Output "  - Rapid deployment scenarios"
          Write-Output "  - Experimental/Lab environments"
          Write-Output ""
          Write-Output "Press Ctrl+C to cancel if this is not what you want."
          Write-Output "Build will continue in 10 seconds..."
          Start-Sleep -Seconds 10

      - name: Download Windows 11 ISO
        shell: powershell
        run: |
          $url = "${{ github.event.inputs.windows_iso_url }}"
          $output = "Win11_Source.iso"

          Write-Output "Downloading Windows 11 ISO from Microsoft servers..."
          Write-Output "URL: $($url.Substring(0, 100))..."

          $startTime = Get-Date

          aria2c `
            --console-log-level=info `
            --summary-interval=30 `
            --max-connection-per-server=${{ env.ARIA2C_CONNECTIONS }} `
            --split=${{ env.ARIA2C_SPLIT }} `
            --min-split-size=5M `
            --max-tries=5 `
            --retry-wait=3 `
            --timeout=60 `
            --connect-timeout=30 `
            --continue=true `
            --allow-overwrite=true `
            --auto-file-renaming=false `
            --file-allocation=none `
            --check-integrity=true `
            --out=$output `
            "$url"

          $downloadTime = (Get-Date) - $startTime

          if (-not (Test-Path $output)) {
            Write-Error "Download failed - ISO file not found"
            exit 1
          }

          $sizeGB = [math]::Round((Get-Item $output).Length / 1GB, 2)
          Write-Output "Download complete: ${sizeGB}GB in $($downloadTime.TotalMinutes.ToString('F2')) minutes"

      - name: Mount Windows ISO
        shell: powershell
        run: |
          $isoPath = Join-Path $PWD "Win11_Source.iso"
          Write-Output "Mounting ISO: $isoPath"

          $mount = Mount-DiskImage -ImagePath $isoPath -PassThru -StorageType ISO

          # Wait for the mount to complete and get drive letter with retries
          $maxRetries = 10
          $retryCount = 0
          $driveLetter = $null

          while (-not $driveLetter -and $retryCount -lt $maxRetries) {
            Start-Sleep -Seconds 5
            try {
              $driveInfo = Get-Volume -DiskImage $mount -ErrorAction SilentlyContinue
              if ($driveInfo -and $driveInfo.DriveLetter) {
                $driveLetter = $driveInfo.DriveLetter
                Write-Output "Drive letter retrieved on attempt $($retryCount + 1): $driveLetter"
              }
            } catch {
              Write-Output "Attempt $($retryCount + 1) failed: $($_.Exception.Message)"
            }
            $retryCount++
          }

          if (-not $driveLetter) {
            Write-Error "Failed to retrieve drive letter after $maxRetries attempts"
            # Try alternative method using WMI
            $drive = Get-CimInstance -ClassName Win32_LogicalDisk | Where-Object { $_.Description -eq "CD-ROM Disc" -and $_.DeviceID -ne $null }
            if ($drive) {
              $driveLetter = $drive.DeviceID.TrimEnd(":")
              Write-Output "Drive letter found via WMI: $driveLetter"
            } else {
              Write-Error "Failed to mount ISO or retrieve drive letter"
              exit 1
            }
          }

          Write-Output "ISO mounted successfully at drive: ${driveLetter}:"

          # Verify critical files exist
          $requiredFiles = @(
            "${driveLetter}:\sources\boot.wim",
            "${driveLetter}:\sources\install.wim",
            "${driveLetter}:\sources\install.esd"
          )

          $foundFiles = $requiredFiles | Where-Object { Test-Path $_ }

          if ($foundFiles.Count -eq 0) {
            Write-Error "No install.wim or install.esd found on mounted ISO"
            exit 1
          }

          Write-Output "Found: $($foundFiles -join ', ')"

          # Persist drive letter for next steps
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_DRIVE=$driveLetter"

      - name: Prepare autounattend.xml
        shell: powershell
        run: |
          if (Test-Path "autounattend.xml") {
            Write-Output "Found local autounattend.xml"
            Copy-Item "autounattend.xml" "scripts\autounattend.xml" -Force
            Write-Output "Copied to scripts directory"
          } else {
            Write-Warning "autounattend.xml not found in root!"
          }

      - name: Verify headless script
        shell: powershell
        run: |
          $scriptPath = ".\scripts\tiny11coremaker-headless.ps1"

          if (-not (Test-Path $scriptPath)) {
            Write-Error "Headless Core script not found at $scriptPath"
            Write-Output "Available files:"
            Get-ChildItem -Path . -Recurse -Filter "*.ps1" | ForEach-Object { Write-Output $_.FullName }
            exit 1
          }

          Write-Output "Headless Core script found: $scriptPath"
          Write-Output "Script size: $([math]::Round((Get-Item $scriptPath).Length / 1KB, 2)) KB"

      - name: Run tiny11coremaker (headless mode)
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force

          $params = @{
            ISO = $env:ISO_DRIVE
            INDEX = [int]"${{ github.event.inputs.image_index }}"
          }

          if ("${{ github.event.inputs.skip_cleanup }}" -eq "true") {
            $params.SkipCleanup = $true
            Write-Output "Cleanup will be skipped (debugging mode)"
          }

          $enableDotNet = [System.Boolean]::Parse("${{ github.event.inputs.enable_dotnet35 }}")
          Write-Output ".NET 3.5: $enableDotNet"

          Write-Output "=== Starting Tiny11 Core Builder ==="
          Write-Output "ISO Drive: $($params.ISO)"
          Write-Output "Image Index: $($params.INDEX)"
          Write-Output ".NET 3.5: $enableDotNet"
          Write-Output "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Output "WARNING: This is a CORE build with aggressive optimization!"

          $startTime = Get-Date

          .\scripts\tiny11coremaker-headless.ps1 @params -ENABLE_DOTNET35:$enableDotNet

          $buildTime = (Get-Date) - $startTime
          Write-Output "Core build completed in $($buildTime.TotalMinutes.ToString('F2')) minutes"

      - name: Verify tiny11 Core ISO creation
        shell: powershell
        run: |
          $tempIso = "scripts\tiny11-core.iso"

          $isoName = "${{ env.ISO_FILENAME }}"

          # Check if ISO was created in scripts directory
          if (-not (Test-Path $tempIso)) {
            Write-Error "$tempIso was not created!"
            Write-Output "Contents of current directory:"
            Get-ChildItem -Path . | Format-Table Name, Length, LastWriteTime
            Write-Output "Contents of scripts directory:"
            Get-ChildItem -Path scripts | Format-Table Name, Length, LastWriteTime
            exit 1
          }

          # Move ISO to root directory and rename to proper filename
          Move-Item -Path $tempIso -Destination $isoName -Force
          Write-Output "ISO moved and renamed to: $isoName"
          if (-not (Test-Path $isoName)) {
            Write-Error "$isoName was not created!"
            Write-Output "Contents of current directory:"
            Get-ChildItem -Path . | Format-Table Name, Length, LastWriteTime
            exit 1
          }

          $sizeGB = [math]::Round((Get-Item $isoName).Length / 1GB, 2)
          Write-Output "$isoName created successfully: ${sizeGB}GB"

          # Generate checksums
          Write-Output "Generating checksums..."
          $sha256 = (Get-FileHash -Path $isoName -Algorithm SHA256).Hash
          $md5 = (Get-FileHash -Path $isoName -Algorithm MD5).Hash

          # Save checksums to files
          "$sha256  $isoName" | Out-File -FilePath "$isoName.sha256" -Encoding ASCII
          "$md5  $isoName" | Out-File -FilePath "$isoName.md5" -Encoding ASCII

          # Create verification file with all info
          $verificationInfo = @"
          Tiny11 Core ISO Verification
          ============================
          File: $isoName
          Size: ${sizeGB}GB
          Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          Image Index: ${{ github.event.inputs.image_index }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          BUILD TYPE: TINY11 CORE (Minimal/WinSxS optimized)
          NOT FOR DAILY USE - Testing/VM only!

          SHA256: $sha256
          MD5: $md5

          To verify:
            certutil -hashfile $isoName SHA256
            certutil -hashfile $isoName MD5

          Disclaimer: This is a highly modified Windows 11 image with reduced serviceability.
          Use only for testing and development purposes.
          "@

          $verificationInfo | Out-File -FilePath "$isoName.txt" -Encoding UTF8

          # Display summary
          Write-Output ""
          Write-Output "=== TINY11 CORE BUILD SUMMARY ==="
          Write-Output "Build completed: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Output "Output size: ${sizeGB}GB"
          Write-Output "SHA256: $sha256"
          Write-Output ""
          Write-Output "!!! THIS IS A TINY11 CORE BUILD !!!"
          Write-Output "Features removed:"
          Write-Output "  - Windows Recovery Environment (WinRE)"
          Write-Output "  - Most WinSxS components (replaced with minimal set)"
          Write-Output "  - Windows Defender services"
          Write-Output "  - Update services (WU disabled)"
          Write-Output ""
          Write-Output "Use only for testing and development!"
          Write-Output "===================================="

          # Persist values for later steps
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_NAME=$isoName"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_SIZE_GB=$sizeGB"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_SHA256=$sha256"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_MD5=$md5"

      - name: Cleanup before upload
        shell: powershell
        run: |
          Write-Output "Cleaning up to free disk space..."

          # Unmount ISO
          $isoPath = Join-Path $PWD "Win11_Source.iso"
          if (Test-Path $isoPath) {
            Get-DiskImage -ImagePath $isoPath | Dismount-DiskImage -ErrorAction SilentlyContinue
            Write-Output "ISO unmounted"
          }

          # Remove source ISO
          Remove-Item "Win11_Source.iso" -Force -ErrorAction SilentlyContinue

          # Remove build logs if they're large
          Get-ChildItem -Path . -Filter "*.log" | Where-Object { $_.Length -gt 10MB } | Remove-Item -Force

          # Display final disk space
          $disk = Get-PSDrive C
          $freeGB = [math]::Round($disk.Free / 1GB, 2)
          Write-Output "Available space after cleanup: ${freeGB}GB"

      - name: Check upload configuration
        id: check-upload
        shell: powershell
        env:
          SF_KEY: ${{ secrets.SF_SSH_KEY }}
          ENABLE_UPLOAD: ${{ vars.ENABLE_SOURCEFORGE_UPLOAD }}
        run: |
          if ($env:ENABLE_UPLOAD -eq 'true' -or -not [string]::IsNullOrWhiteSpace($env:SF_KEY)) {
            Write-Output "Upload condition met."
            "DO_UPLOAD=true" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          } else {
            Write-Output "Upload condition NOT met. Fallback to artifacts."
            "DO_UPLOAD=false" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          }

      - name: Display final warnings
        shell: powershell
        run: |
          Write-Output ""
          Write-Output "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          Write-Output "  TINY11 CORE BUILD COMPLETED"
          Write-Output "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          Write-Output ""
          Write-Output "Build: ${{ env.ISO_NAME }}"
          Write-Output "Size: ${{ env.ISO_SIZE_GB }}GB"
          Write-Output "SHA256: ${{ env.ISO_SHA256 }}"
          Write-Output ""
          Write-Output "‚ö†Ô∏è  IMPORTANT WARNINGS:"
          Write-Output ""
          Write-Output "This is a TINY11 CORE build with aggressive optimization:"
          Write-Output "  ‚úó WinRE removed - No recovery environment"
          Write-Output "  ‚úó WinSxS minimized - Cannot add features/updates"
          Write-Output "  ‚úó Defender disabled - No built-in antivirus"
          Write-Output "  ‚úó Updates disabled - Manual updates only"
          Write-Output ""
          Write-Output "Appropriate use cases:"
          Write-Output "  ‚úì Testing Windows 11 in VMs"
          Write-Output "  ‚úì Application compatibility testing"
          Write-Output "  ‚úì Development environments"
          Write-Output "  ‚úì Disposable/throwaway Windows instances"
          Write-Output ""
          Write-Output "NOT suitable for:"
          Write-Output "  ‚úó Primary/daily-use systems"
          Write-Output "  ‚úó Systems requiring security updates"
          Write-Output "  ‚úó Production environments"
          Write-Output "  ‚úó Systems needing future feature additions"
          Write-Output ""
          Write-Output "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          Write-Output "  USE AT YOUR OWN RISK"
          Write-Output "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          Write-Output ""

      - name: Validate SourceForge credentials
        if: env.DO_UPLOAD == 'true'
        env:
          SF_SSH_KEY: ${{ secrets.SF_SSH_KEY }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        shell: powershell
        run: |
          if ([string]::IsNullOrWhiteSpace($env:SF_SSH_KEY)) {
            Write-Error "SF_SSH_KEY secret is not configured"
            exit 1
          }
          if ([string]::IsNullOrWhiteSpace($env:SF_USERNAME)) {
            Write-Error "SF_USERNAME secret is not configured"
            exit 1
          }
          
          Write-Output "Credentials validated successfully"
          
      - name: Setup SSH for SourceForge
        if: env.DO_UPLOAD == 'true'
        shell: powershell
        env:
          SF_PROJECT: ${{ secrets.SF_PROJECT }}
          SF_SSH_KEY: ${{ secrets.SF_SSH_KEY }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          # 1. Validation
          if ([string]::IsNullOrWhiteSpace($env:SF_SSH_KEY)) { Write-Error "Secret SF_SSH_KEY is missing"; exit 1 }
          
          # Fallback for Project Name
          if ([string]::IsNullOrWhiteSpace($env:SF_PROJECT)) {
            $env:SF_PROJECT = "${{ github.event.repository.name }}"
          }
          Add-Content -Path $env:GITHUB_ENV -Value "SF_PROJECT=$env:SF_PROJECT"
          
          # 2. Create SSH Directory
          $sshDir = "$env:USERPROFILE\.ssh"
          if (!(Test-Path $sshDir)) { New-Item -ItemType Directory -Force -Path $sshDir | Out-Null }
          
          $keyPath = "$sshDir\sf_key"
          
          # 3. Write Private Key (BASE64 DECODE FIX)
          try {
            $keyBytes = [System.Convert]::FromBase64String($env:SF_SSH_KEY)
            [System.IO.File]::WriteAllBytes($keyPath, $keyBytes)
          } catch {
            Write-Error "Failed to decode SF_SSH_KEY. Did you Base64 encode it in Termux first?"
            exit 1
          }
          
          # 4. Fix Permissions (Windows ACLs)
          icacls $keyPath /c /t /inheritance:d
          icacls $keyPath /c /t /grant "${env:USERNAME}:F"
          icacls $keyPath /c /t /remove Administrator "Authenticated Users" BUILTIN\Administrators BUILTIN\Users
          
          # 5. Add Known Host
          ssh-keyscan -t rsa,ecdsa,ed25519 frs.sourceforge.net | Out-File -FilePath "$sshDir\known_hosts" -Encoding ascii
          
          Write-Output "SSH configuration complete."

      - name: Upload to SourceForge (Recursive Method)
        if: env.DO_UPLOAD == 'true'
        shell: powershell
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PROJECT: ${{ secrets.SF_PROJECT }}
          ISO_NAME: ${{ env.ISO_NAME }}
          FOLDER_NAME: ${{ env.FOLDER_NAME }}
        run: |
          $keyPath = "$env:USERPROFILE\.ssh\sf_key"

          # 1. Prepare a local folder
          Write-Output "Organizing files into folder: $env:FOLDER_NAME"
          New-Item -ItemType Directory -Force -Path $env:FOLDER_NAME | Out-Null

          # 2. Copy files into this folder
          Copy-Item $env:ISO_NAME $env:FOLDER_NAME
          Copy-Item "$env:ISO_NAME.sha256" $env:FOLDER_NAME
          Copy-Item "$env:ISO_NAME.md5" $env:FOLDER_NAME
          Copy-Item "$env:ISO_NAME.txt" $env:FOLDER_NAME

          # Copy SourceForge README
          if (Test-Path "SOURCEFORGE_README.md") {
            Copy-Item "SOURCEFORGE_README.md" $env:FOLDER_NAME
            Write-Output "Copied SOURCEFORGE_README.md to folder"
          }

          # 3. Upload the WHOLE folder
          $remoteRoot = "$env:SF_USERNAME@frs.sourceforge.net:/home/frs/project/$env:SF_PROJECT/"

          Write-Output "Uploading folder..."
          scp -i $keyPath -r -o StrictHostKeyChecking=no $env:FOLDER_NAME $remoteRoot

          if ($LASTEXITCODE -ne 0) {
            Write-Error "SCP Upload failed"
            exit 1
          }
          Write-Output "Upload success!"

          # 4. Set Download URL
          $downloadUrl = "https://sourceforge.net/projects/$env:SF_PROJECT/files/$env:RELEASE_TAG/$env:ISO_NAME/download"
          Add-Content -Path $env:GITHUB_ENV -Value "SF_DOWNLOAD_URL=$downloadUrl"
          
      - name: Cleanup SSH credentials
        if: always()
        shell: powershell
        run: |
          $keyPath = "$env:USERPROFILE\.ssh\sf_key"
          if (Test-Path $keyPath) {
            Remove-Item $keyPath -Force -ErrorAction SilentlyContinue
            Write-Output "SSH key cleaned up"
          }
          
      - name: Upload ISO as artifact (fallback)
        if: env.DO_UPLOAD != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: |
            ${{ env.ISO_NAME }}
            ${{ env.ISO_NAME }}.sha256
            ${{ env.ISO_NAME }}.md5
            ${{ env.ISO_NAME }}.txt
          retention-days: 7
          compression-level: 0

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Tiny11 Core Windows 11 ${{ github.event.inputs.windows_version }} - ${{ env.RELEASE_TAG }}
          body: |
            ## üöÄ Tiny11 Core Windows 11 ${{ github.event.inputs.windows_version }} Build

            **Automated build by kelexine's workflow**

            ### üì¶ Build Information
            - **Built with:** [tiny11builder](https://github.com/ntdevlabs/tiny11builder) by ntdevlabs
            - **Modified by:** [kelexine](https://github.com/kelexine)
            - **Build Date:** ${{ github.event.repository.updated_at }}
            - **Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### üì• Download
            ${{ secrets.SF_SSH_KEY != '' && format('**SourceForge:** [{0}]({1})', env.ISO_NAME, env.SF_DOWNLOAD_URL) || '**GitHub Artifacts:** Check workflow run for download' }}

            ### üíø Image Details
            | Property | Value |
            |----------|-------|
            | **File** | ${{ env.ISO_NAME }} |
            | **Size** | ${{ env.ISO_SIZE_GB }}GB |
            | **Type** | Core (Minimal/Non-Serviceable) |
            | **Base** | Windows 11 ${{ github.event.inputs.windows_version }} |
            | **Index** | ${{ github.event.inputs.image_index }} |
            | **Language** | ${{ github.event.inputs.language }} |
            | **.NET 3.5** | ${{ github.event.inputs.enable_dotnet35 }} |

            ### üîí Checksums

            **SHA256:**
            ```
            ${{ env.ISO_SHA256 }}
            ```

            **MD5:**
            ```
            ${{ env.ISO_MD5 }}
            ```

            ### ‚ùå What's Removed
            - **Windows Recovery Environment (WinRE)**
            - **Windows Component Store (WinSxS)**
            - **Windows Defender & Security Services**
            - **Windows Update Service**
            - Microsoft Edge, EdgeWebView, Edge Update
            - OneDrive, Teams, Copilot, Chat
            - Sponsored apps and suggestions
            - Telemetry and diagnostics

            ### ‚ö†Ô∏è Core Limitations
            - ‚ùå **NOT Serviceable** - Cannot add languages or features
            - ‚ùå **NO Updates** - Cannot install Cumulative Updates
            - ‚ùå **NO Recovery** - No "Reset this PC" or Advanced Startup
            - ‚ùå **NO Defender** - No real-time protection

            ### ‚úÖ Features
            - ‚úÖ Extreme footprint reduction (~2GB ISO, ~6-8GB Installed)
            - ‚úÖ Lowest possible resource usage
            - ‚úÖ Bypasses all requirements (TPM, Secure Boot, RAM)
            - ‚úÖ Perfect for VMs and testing
            - ‚úÖ Local account support on OOBE

            ### üìã Windows Editions
            | Index | Edition |
            |-------|---------|
            | 1 | Home |
            | 4 | Education |
            | 6 | Pro |
            | 7 | Pro N |

            ---

            **‚ö†Ô∏è Disclaimer:** This is an unofficial Windows 11 modification. Use at your own risk. Not affiliated with Microsoft.

            **üìú License:** Educational purposes only. Requires valid Windows license from Microsoft.
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            ${{ env.ISO_NAME }}.sha256
            ${{ env.ISO_NAME }}.md5
            ${{ env.ISO_NAME }}.txt
          
      - name: Workflow summary
        shell: powershell
        run: |
          $summary = @"
          # ‚úÖ Tiny11 Core Build Completed Successfully

          ## üì¶ Build Information
          - **ISO:** $env:ISO_NAME
          - **Size:** $env:ISO_SIZE_GB GB
          - **Release:** ${{ env.RELEASE_TAG }}
          - **Version:** ${{ github.event.inputs.windows_version }}
          - **Type:** Core (Minimal)
          - **.NET 3.5:** ${{ github.event.inputs.enable_dotnet35 }}

          ## üì• Download
          ${{ secrets.SF_SSH_KEY != '' && format('üîó **SourceForge:** [{0}]({1})', env.ISO_NAME, env.SF_DOWNLOAD_URL) || 'üîó **GitHub Artifacts:** Available in workflow run' }}

          ## üîí Checksums
          **SHA256:** ``````
          $env:ISO_SHA256
          ``````

          **MD5:** ``````
          $env:ISO_MD5
          ``````

          ## ‚ö†Ô∏è Warnings
          - No WinRE (Recovery)
          - No WinSxS (Updates)
          - No Defender
          - Testing/VM Use Only

          ## ‚è±Ô∏è Build Time
          Completed at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

          ---
          Built by [kelexine](https://github.com/kelexine) | Original by [ntdevlabs](https://github.com/ntdevlabs)
          "@

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

