# .github/workflows/version-matrix-builder.yml
# Automated Windows Release Detection & Build Trigger System
# Author: kelexine (https://github.com/kelexine)

name: Version Matrix Builder

on:
  schedule:
    # Run daily at 00:00 UTC to check for new releases
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check even if no new version detected'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build trigger (detection only)'
        required: false
        type: boolean
        default: false

# Required permissions for the workflow
permissions:
  contents: write      # For committing tracking file
  issues: write        # For creating GitHub issues
  actions: write       # For triggering other workflows

env:
  RELEASE_TRACKING_FILE: 'tracked_releases.json'
  
jobs:
  detect-releases:
    name: Detect New Windows Releases
    runs-on: ubuntu-latest
    outputs:
      new_releases: ${{ steps.check.outputs.new_releases }}
      releases_matrix: ${{ steps.check.outputs.releases_matrix }}
      has_new: ${{ steps.check.outputs.has_new }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Scripts Directory
        run: |
          # Ensure scripts directory exists
          mkdir -p scripts
          
          # If release_detector.py doesn't exist in scripts, check root
          if [ ! -f "scripts/release_detector.py" ] && [ -f "release_detector.py" ]; then
            echo "üì¶ Moving release_detector.py to scripts/"
            mv release_detector.py scripts/
          fi
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'
      
      - name: Install Dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            # Fallback to direct install if no requirements file
            pip install requests beautifulsoup4 lxml playwright
          fi

      - name: Install Playwright Browsers
        run: playwright install --with-deps chromium
      
      - name: Fetch Current Tracked Releases
        id: fetch_tracked
        run: |
          # GitHub Actions output doesn't handle large multi-line JSON well
          # We'll just check if file exists for now
          if [ -f "${{ env.RELEASE_TRACKING_FILE }}" ]; then
            echo "has_tracking=true" >> $GITHUB_OUTPUT
            echo "üìã Found existing tracking file"
          else
            echo "has_tracking=false" >> $GITHUB_OUTPUT
            echo "üìã No existing tracking file"
          fi
      
      - name: Check for New Releases
        id: check
        env:
          FORCE_CHECK: ${{ github.event.inputs.force_check || 'false' }}
        run: |
          echo "=================================="
          echo "üîç Windows Release Detection"
          echo "=================================="
          echo "Force check: $FORCE_CHECK"
          echo "Tracking file: ${{ env.RELEASE_TRACKING_FILE }}"
          echo ""
          
          # Build command with conditional --force flag
          if [ "$FORCE_CHECK" = "true" ]; then
            echo "üîÑ Running with --force flag (will re-check recently detected builds)"
            python3 scripts/release_detector.py \
              --force \
              --output=detector_output.txt \
              --tracking-file=${{ env.RELEASE_TRACKING_FILE }}
          else
            echo "üìÖ Running normal check (skips if checked within last hour)"
            python3 scripts/release_detector.py \
              --output=detector_output.txt \
              --tracking-file=${{ env.RELEASE_TRACKING_FILE }}
          fi
          
          DETECTOR_EXIT=$?
          echo ""
          echo "Detector exit code: $DETECTOR_EXIT"
          
          if [ $DETECTOR_EXIT -ne 0 ]; then
            echo "‚ùå Detector script failed!"
            echo "has_new=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Read outputs from file and set GitHub Actions outputs
          if [ -f "detector_output.txt" ]; then
            echo ""
            echo "üìÑ Reading detector outputs..."
            echo "=================================="
            
            # Read each line and set as output
            while IFS='=' read -r key value; do
              # Skip empty lines and comments
              if [ -n "$key" ] && [[ ! "$key" =~ ^# ]]; then
                echo "$key=$value" >> $GITHUB_OUTPUT
                
                # Show appropriate output based on size
                if [ ${#value} -gt 200 ]; then
                  echo "‚úì Set output: $key (${#value} chars - JSON data)"
                elif [ ${#value} -gt 50 ]; then
                  echo "‚úì Set output: $key=${value:0:50}... (${#value} chars)"
                else
                  echo "‚úì Set output: $key=$value"
                fi
              fi
            done < detector_output.txt
            
            echo "=================================="
            echo "‚úÖ Outputs set successfully"
          else
            echo "‚ùå Detector output file not found!"
            echo "has_new=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Commit Updated Tracking File
        if: steps.check.outputs.has_new == 'true'
        id: commit_tracking
        run: |
          git config user.name "Version Matrix Bot"
          git config user.email "bot@kelexine.dev"
          git add ${{ env.RELEASE_TRACKING_FILE }}
          
          if git commit -m "ü§ñ Update tracked releases - $(date -u +'%Y-%m-%d %H:%M UTC')"; then
            echo "commit_made=true" >> $GITHUB_OUTPUT
            if git push origin main; then
              echo "push_success=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Tracking file committed and pushed successfully"
            else
              echo "push_success=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Push failed - may need manual sync"
            fi
          else
            echo "commit_made=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes to commit"
          fi
      
      - name: Send Discord Notification - New Releases
        if: steps.check.outputs.has_new == 'true'
        continue-on-error: true
        run: |
          echo "üì¢ Sending Discord notification..."
          python3 scripts/discord_notify.py \
            --webhook "${{ secrets.DISCORD_WEBHOOK_RELEASES }}" \
            --type new-releases \
            --data '${{ steps.check.outputs.new_releases }}' || echo "Discord notification failed (continuing)"
      
      - name: Create GitHub Issue for New Release
        if: steps.check.outputs.has_new == 'true'
        id: create_issues
        uses: actions/github-script@v7
        continue-on-error: true
        env:
          NEW_RELEASES_JSON: ${{ steps.check.outputs.new_releases }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Safely parse JSON using base64 to avoid quote issues
            const releasesJson = process.env.NEW_RELEASES_JSON || '[]';
            let newReleases;
            try {
              newReleases = JSON.parse(releasesJson);
            } catch (e) {
              console.error('Failed to parse releases JSON:', e.message);
              newReleases = [];
            }
            
            console.log(`üìù Creating ${newReleases.length} issue(s)...`);
            
            let created = 0;
            let failed = 0;
            
            for (const release of newReleases) {
              const issueBody = `## üéâ New Windows Release Detected

            **Build Information:**
            - **Title:** ${release.title}
            - **Build Number:** ${release.build_number}
            - **Version:** ${release.version}
            - **Architecture:** ${release.architecture}
            - **Detection Date:** ${release.detected_date}

            **ISO Source:**
            - ${release.iso_url}

            **Automated Actions:**
            - [ ] Trigger Tiny11 Standard build
            - [ ] Trigger Tiny11 Core build
            - [ ] Trigger Nano11 build
            - [ ] Test builds in VM
            - [ ] Upload to SourceForge

            ---
            *This issue was automatically created by the Version Matrix Builder*
            `.trim();
            
              try {
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `üÜï New Windows ${release.version} Release - Build ${release.build_number}`,
                  body: issueBody,
                  labels: ['automated', 'new-release', 'build-pending']
                });
                
                console.log(`‚úÖ Created issue #${issue.data.number}: ${release.title}`);
                created++;
              } catch (error) {
                console.error(`‚ùå Failed to create issue for ${release.title}: ${error.message}`);
                failed++;
              }
            }
            
            console.log(`‚úÖ Issue creation completed: ${created} created, ${failed} failed`);
                      
      - name: Summary of Issue Creation
        if: steps.check.outputs.has_new == 'true'
        run: |
          echo "üìä Issue Creation Summary:"
          echo "  Step outcome: ${{ steps.create_issues.outcome }}"
          if [ "${{ steps.create_issues.outcome }}" = "success" ]; then
            echo "  ‚úÖ All issues created successfully"
          else
            echo "  ‚ö†Ô∏è  Some issues may have failed (check logs above)"
            echo "  ‚ÑπÔ∏è  This won't prevent builds from triggering"
          fi

  trigger-builds:
    name: Trigger Automated Builds
    needs: detect-releases
    if: needs.detect-releases.outputs.has_new == 'true' && (github.event_name == 'schedule' || github.event.inputs.skip_build != 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        release: ${{ fromJson(needs.detect-releases.outputs.releases_matrix) }}
        build_type: ['standard', 'core', 'nano']
        edition: [1, 6]  # Home and Pro
    
    steps:
      - name: Trigger Build Workflow
        uses: actions/github-script@v7
        with:
          script: |
            const workflowMap = {
              'standard': 'build-tiny11.yml',
              'core': 'build-tiny11-core.yml',
              'nano': 'build-nano11.yml'
            };
            
            const editionMap = {
              1: 'Home',
              6: 'Pro'
            };
            
            const workflow = workflowMap['${{ matrix.build_type }}'];
            const release = ${{ toJson(matrix.release) }};
            const edition = ${{ matrix.edition }};
            
            console.log(`üöÄ Triggering ${workflow} for ${release.version} (${editionMap[edition]})`);
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              ref: 'main',
              inputs: {
                windows_iso_url: release.iso_url,
                image_index: edition.toString(),
                skip_cleanup: 'false',
                windows_version: release.version,
                language: 'English'
              }
            });
            
            console.log(`‚úÖ Build triggered successfully!`);

  notify-completion:
    name: Send Completion Notification
    needs: [detect-releases, trigger-builds]
    if: always() && needs.detect-releases.outputs.has_new == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: scripts
          sparse-checkout-cone-mode: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: pip install requests
      
      - name: Send Discord Notification
        continue-on-error: true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RELEASES }}
          BUILDS_RESULT: ${{ needs.trigger-builds.result }}
          NEW_RELEASES: ${{ needs.detect-releases.outputs.new_releases }}
        run: |
          echo "üì¢ Version Matrix Builder completed!"
          echo "New releases detected: ${{ needs.detect-releases.outputs.has_new }}"
          echo "Builds triggered: $BUILDS_RESULT"
          
            # Calculate build count (releases * 3 variants * 2 editions = 6 builds per release)
            RELEASES_COUNT=$(echo $NEW_RELEASES | python3 -c "import sys, json; print(len(json.load(sys.stdin)))")
            BUILDS_COUNT=$((RELEASES_COUNT * 6))
            
            # Send Discord notification
            if [ -n "$DISCORD_WEBHOOK" ]; then
              python3 scripts/discord_notify.py \
                --webhook "$DISCORD_WEBHOOK" \
                --type builds-triggered \
                --data "{\"builds_count\":$BUILDS_COUNT,\"releases\":$NEW_RELEASES}" || echo "Discord notification failed"
          else
            echo "‚ö†Ô∏è DISCORD_WEBHOOK_RELEASES not configured, skipping notification"
          fi
