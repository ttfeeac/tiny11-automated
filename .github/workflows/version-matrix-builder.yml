# .github/workflows/version-matrix-builder.yml
# Automated Windows Release Detection & Build Trigger System
# Author: kelexine (https://github.com/kelexine)

name: Version Matrix Builder

on:
  schedule:
    # Run daily at 00:00 UTC to check for new releases
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check even if no new version detected'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build trigger (detection only)'
        required: false
        type: boolean
        default: false

# Required permissions for the workflow
permissions:
  contents: write      # For committing tracking file
  issues: write        # For creating GitHub issues
  actions: write       # For triggering other workflows

env:
  # Windows release monitoring endpoints
  UUPDUMP_API: 'https://api.uupdump.net'
  RELEASE_TRACKING_FILE: 'tracked_releases.json'
  
jobs:
  detect-releases:
    name: Detect New Windows Releases
    runs-on: ubuntu-latest
    outputs:
      new_releases: ${{ steps.check.outputs.new_releases }}
      releases_matrix: ${{ steps.check.outputs.releases_matrix }}
      has_new: ${{ steps.check.outputs.has_new }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Scripts Directory
        run: |
          # Ensure scripts directory exists
          mkdir -p scripts
          
          # If release_detector.py doesn't exist in scripts, check root
          if [ ! -f "scripts/release_detector.py" ] && [ -f "release_detector.py" ]; then
            echo "ðŸ“¦ Moving release_detector.py to scripts/"
            mv release_detector.py scripts/
          fi
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'
      
      - name: Install Dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            # Fallback to direct install if no requirements file
            pip install requests beautifulsoup4 lxml
          fi
      
      - name: Fetch Current Tracked Releases
        id: fetch_tracked
        run: |
          # GitHub Actions output doesn't handle large multi-line JSON well
          # We'll just check if file exists for now
          if [ -f "${{ env.RELEASE_TRACKING_FILE }}" ]; then
            echo "has_tracking=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Found existing tracking file"
          else
            echo "has_tracking=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No existing tracking file"
          fi
      
      - name: Check for New Releases
        id: check
        env:
          FORCE_CHECK: ${{ github.event.inputs.force_check || 'false' }}
        run: |
          echo "=================================="
          echo "ðŸ” Windows Release Detection"
          echo "=================================="
          echo "Force check: $FORCE_CHECK"
          echo "Tracking file: ${{ env.RELEASE_TRACKING_FILE }}"
          echo ""
          
          # Build command with conditional --force flag
          if [ "$FORCE_CHECK" = "true" ]; then
            echo "ðŸ”„ Running with --force flag (will re-check recently detected builds)"
            python3 scripts/release_detector.py \
              --force \
              --output=detector_output.txt \
              --tracking-file=${{ env.RELEASE_TRACKING_FILE }}
          else
            echo "ðŸ“… Running normal check (skips if checked within last hour)"
            python3 scripts/release_detector.py \
              --output=detector_output.txt \
              --tracking-file=${{ env.RELEASE_TRACKING_FILE }}
          fi
          
          DETECTOR_EXIT=$?
          echo ""
          echo "Detector exit code: $DETECTOR_EXIT"
          
          if [ $DETECTOR_EXIT -ne 0 ]; then
            echo "âŒ Detector script failed!"
            echo "has_new=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Read outputs from file and set GitHub Actions outputs
          if [ -f "detector_output.txt" ]; then
            echo ""
            echo "ðŸ“„ Reading detector outputs..."
            echo "=================================="
            
            # Read each line and set as output
            while IFS='=' read -r key value; do
              # Skip empty lines and comments
              if [ -n "$key" ] && [[ ! "$key" =~ ^# ]]; then
                echo "$key=$value" >> $GITHUB_OUTPUT
                
                # Show appropriate output based on size
                if [ ${#value} -gt 200 ]; then
                  echo "âœ“ Set output: $key (${#value} chars - JSON data)"
                elif [ ${#value} -gt 50 ]; then
                  echo "âœ“ Set output: $key=${value:0:50}... (${#value} chars)"
                else
                  echo "âœ“ Set output: $key=$value"
                fi
              fi
            done < detector_output.txt
            
            echo "=================================="
            echo "âœ… Outputs set successfully"
          else
            echo "âŒ Detector output file not found!"
            echo "has_new=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Commit Updated Tracking File
        if: steps.check.outputs.has_new == 'true'
        run: |
          git config user.name "Version Matrix Bot"
          git config user.email "bot@kelexine.dev"
          git add ${{ env.RELEASE_TRACKING_FILE }}
          git commit -m "ðŸ¤– Update tracked releases - $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "No changes to commit"
          git push origin main || echo "Push failed, continuing..."
      
      - name: Create GitHub Issue for New Release
        if: steps.check.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newReleases = JSON.parse('${{ steps.check.outputs.new_releases }}');
            
            for (const release of newReleases) {
              const issueBody = `
              ## ðŸŽ‰ New Windows Release Detected
              
              **Build Information:**
              - **Title:** ${release.title}
              - **Build Number:** ${release.build_number}
              - **Version:** ${release.version}
              - **Architecture:** ${release.architecture}
              - **Detection Date:** ${release.detected_date}
              
              **ISO Source:**
              - ${release.iso_url}
              
              **Automated Actions:**
              - [ ] Trigger Tiny11 Standard build
              - [ ] Trigger Tiny11 Core build
              - [ ] Trigger Nano11 build
              - [ ] Test builds in VM
              - [ ] Upload to SourceForge
              
              ---
              *This issue was automatically created by the Version Matrix Builder*
              `;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ†• New Windows ${release.version} Release - Build ${release.build_number}`,
                body: issueBody,
                labels: ['automated', 'new-release', 'build-pending']
              });
            }

  trigger-builds:
    name: Trigger Automated Builds
    needs: detect-releases
    if: needs.detect-releases.outputs.has_new == 'true' && github.event.inputs.skip_build != 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        release: ${{ fromJson(needs.detect-releases.outputs.releases_matrix) }}
        build_type: ['standard', 'core', 'nano']
        edition: [1, 6]  # Home and Pro
    
    steps:
      - name: Trigger Build Workflow
        uses: actions/github-script@v7
        with:
          script: |
            const workflowMap = {
              'standard': 'build-tiny11.yml',
              'core': 'build-tiny11-core.yml',
              'nano': 'build-nano11.yml'
            };
            
            const editionMap = {
              1: 'Home',
              6: 'Pro'
            };
            
            const workflow = workflowMap['${{ matrix.build_type }}'];
            const release = ${{ toJson(matrix.release) }};
            const edition = ${{ matrix.edition }};
            
            console.log(`ðŸš€ Triggering ${workflow} for ${release.version} (${editionMap[edition]})`);
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              ref: 'main',
              inputs: {
                windows_iso_url: release.iso_url,
                image_index: edition.toString(),
                skip_cleanup: 'false',
                windows_version: release.version
              }
            });
            
            console.log(`âœ… Build triggered successfully!`);

  notify-completion:
    name: Send Notification
    needs: [detect-releases, trigger-builds]
    if: always() && needs.detect-releases.outputs.has_new == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Notification
        run: |
          echo "ðŸ“¢ Version Matrix Builder completed!"
          echo "New releases detected: ${{ needs.detect-releases.outputs.has_new }}"
          echo "Builds triggered: ${{ needs.trigger-builds.result }}"
          
          # Add Discord/Slack/Email notification here if needed
          # Example with webhook:
          # curl -X POST $WEBHOOK_URL -H 'Content-Type: application/json' \
          #   -d '{"content":"ðŸŽ‰ New Windows release detected and builds triggered!"}'
