# GitHub Actions Workflow for building Tiny11 ISO
# Author: kelexine (https://github.com/kelexine)
# Description: Fully automated Windows 11 ISO processing with tiny11builder
# Repository: https://github.com/kelexine/tiny11-automated

name: Build and Release Tiny11

on:
  workflow_dispatch:
    inputs:
      windows_version:
        description: 'Windows version (e.g., 24H2, 25H2)'
        required: false
        default: '25H2'
      windows_iso_url:
        description: 'Windows 11 ISO download URL'
        required: true
        default: 'https://software.download.prss.microsoft.com/dbazure/Win11_25H2_English_x64.iso?t=84586cf6-9b51-4717-9c9e-43a147d13a76&P1=1765723100&P2=601&P3=2&P4=i01rQ%2fmrl%2buVppty0J5Sz%2fJ%2bagMP6ntwQbEymbF3T4N%2bBq%2fRQTaW6Ei%2fa%2fXNhGswmzAOOcPaTghphTtFMF0EX7U14aQxP%2fz%2bkgwKiCxLkH7ozABPxZyqf2SimL4OEhpOaR5BaeuOEvyLpFbk1NCf%2bK8xQqKQCvKIjqFJY7hgjkxWtuDIxsTMRZz5gXxmnStihqqgOYo%2fBkwQp7tMrn8V%2bQrWo9OrFMWyCUWMY2imfKCi5q0VFKhgBki52qhTJbxVR3IUsGgyXw2Xzk5DjJQ906IBtpTl3h7vSEDDw714sziwq0yMwdpN2WHbjZVt5mcqaYdg1GoWdM9xK6kL7tT6Tw%3d%3d'
      image_index:
        description: 'Windows image index (1=Home, 4=Education, 6=Pro, 7=Pro N)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '4'
          - '6'
          - '7'
      language:
        description: 'Language (e.g., English, Spanish, French)'
        required: false
        default: 'English'
      skip_cleanup:
        description: 'Skip cleanup (for debugging)'
        required: false
        default: false
        type: boolean

env:
  ARIA2C_CONNECTIONS: '16'
  ARIA2C_SPLIT: '16'
  POWERSHELL_TELEMETRY_OPTOUT: '1'

jobs:
  build-tiny11:
    runs-on: windows-latest
    timeout-minutes: 360
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate release tag and ISO name
        shell: powershell
        run: |
          # Get date for tag and ISO naming
          $date = Get-Date -Format 'yyyy-MM-dd'
          $version = "${{ github.event.inputs.windows_version }}"

          # Get edition based on index
          $index = "${{ github.event.inputs.image_index }}"
          $editions = @{
              "1" = "Home"
              "4" = "Education"
              "6" = "Pro"
              "7" = "ProN"
          }
          $edition = $editions[$index]

          $language = "${{ github.event.inputs.language }}" -replace '[^a-zA-Z]', ''

          # Generate tag and names - New structure: Tiny11-EDITION-VERSION for folders
          $folderName = "Tiny11-$edition-$version"
          $isoName = "Tiny11-$version-$language-$edition-$date.iso"

          # For GitHub releases, we'll use a more specific tag with date
          $baseTag = "tiny11-$version-$date"

          # Check if tag already exists
          $existingTags = $(git tag -l "$baseTag*" | Measure-Object).Count
          if ($existingTags -gt 0) {
              $baseTag = "$baseTag-$($existingTags + 1)"
          }

          Write-Output "Generated tag: $baseTag"
          Write-Output "Generated ISO name: $isoName"
          Write-Output "Generated folder name: $folderName"

          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_TAG=$baseTag"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_FILENAME=$isoName"
          Add-Content -Path $env:GITHUB_ENV -Value "FOLDER_NAME=$folderName"
        
      - name: System information
        shell: powershell
        run: |
          Write-Output "=== System Information ==="
          Write-Output "OS: $(Get-CimInstance Win32_OperatingSystem | Select-Object -ExpandProperty Caption)"
          Write-Output "PowerShell: $($PSVersionTable.PSVersion)"
          Write-Output "Architecture: $env:PROCESSOR_ARCHITECTURE"
          
          $disk = Get-PSDrive C
          $freeGB = [math]::Round($disk.Free / 1GB, 2)
          $totalGB = [math]::Round($disk.Used / 1GB + $disk.Free / 1GB, 2)
          Write-Output "Disk C: ${freeGB}GB free / ${totalGB}GB total"
          
          if ($freeGB -lt 25) {
            Write-Error "Insufficient disk space. At least 25GB required, found ${freeGB}GB"
            exit 1
          }
          
      - name: Install aria2c
        shell: powershell
        run: |
          Write-Output "Installing aria2c for faster downloads..."
          choco install aria2 -y --no-progress
          aria2c --version
          
      - name: Download Windows 11 ISO
        shell: powershell
        run: |
          $url = "${{ github.event.inputs.windows_iso_url }}"
          $output = "Win11_Source.iso"
          
          Write-Output "Downloading Windows 11 ISO from Microsoft servers..."
          Write-Output "URL: $($url.Substring(0, 100))..."
          
          $startTime = Get-Date
          
          aria2c `
            --console-log-level=info `
            --summary-interval=30 `
            --max-connection-per-server=${{ env.ARIA2C_CONNECTIONS }} `
            --split=${{ env.ARIA2C_SPLIT }} `
            --min-split-size=5M `
            --max-tries=5 `
            --retry-wait=3 `
            --timeout=60 `
            --connect-timeout=30 `
            --continue=true `
            --allow-overwrite=true `
            --auto-file-renaming=false `
            --file-allocation=none `
            --check-integrity=true `
            --out=$output `
            "$url"
          
          $downloadTime = (Get-Date) - $startTime
          
          if (-not (Test-Path $output)) {
            Write-Error "Download failed - ISO file not found"
            exit 1
          }
          
          $sizeGB = [math]::Round((Get-Item $output).Length / 1GB, 2)
          Write-Output "Download complete: ${sizeGB}GB in $($downloadTime.TotalMinutes.ToString('F2')) minutes"
          
      - name: Mount Windows ISO
        shell: powershell
        run: |
          $isoPath = Join-Path $PWD "Win11_Source.iso"
          Write-Output "Mounting ISO: $isoPath"
          
          $mount = Mount-DiskImage -ImagePath $isoPath -PassThru -StorageType ISO
          Start-Sleep -Seconds 3
          
          $driveLetter = ($mount | Get-Volume).DriveLetter
          
          if (-not $driveLetter) {
            Write-Error "Failed to mount ISO or retrieve drive letter"
            exit 1
          }
          
          Write-Output "ISO mounted successfully at drive: ${driveLetter}:"
          
          # Verify critical files exist
          $requiredFiles = @(
            "${driveLetter}:\sources\boot.wim",
            "${driveLetter}:\sources\install.wim",
            "${driveLetter}:\sources\install.esd"
          )
          
          $foundFiles = $requiredFiles | Where-Object { Test-Path $_ }
          
          if ($foundFiles.Count -eq 0) {
            Write-Error "No install.wim or install.esd found on mounted ISO"
            exit 1
          }
          
          Write-Output "Found: $($foundFiles -join ', ')"
          
          # Persist drive letter for next steps
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_DRIVE=$driveLetter"
          
      - name: Prepare autounattend.xml
        shell: powershell
        run: |
          if (Test-Path "autounattend.xml") {
            Write-Output "Found local autounattend.xml"
            Copy-Item "autounattend.xml" "scripts\autounattend.xml" -Force
            Write-Output "Copied to scripts directory"
          } else {
            Write-Warning "autounattend.xml not found in root!"
          }
          
      - name: Verify headless script
        shell: powershell
        run: |
          $scriptPath = ".\scripts\tiny11maker-headless.ps1"
          
          if (-not (Test-Path $scriptPath)) {
            Write-Error "Headless script not found at $scriptPath"
            Write-Output "Available files:"
            Get-ChildItem -Path . -Recurse -Filter "*.ps1" | ForEach-Object { Write-Output $_.FullName }
            exit 1
          }
          
          Write-Output "Headless script found: $scriptPath"
          
      - name: Run tiny11maker (headless mode)
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          
          $params = @{
            ISO = $env:ISO_DRIVE
            INDEX = [int]"${{ github.event.inputs.image_index }}"
          }
          
          if ("${{ github.event.inputs.skip_cleanup }}" -eq "true") {
            $params.SkipCleanup = $true
            Write-Output "Cleanup will be skipped (debugging mode)"
          }
          
          Write-Output "=== Starting Tiny11 Builder ==="
          Write-Output "ISO Drive: $($params.ISO)"
          Write-Output "Image Index: $($params.INDEX)"
          Write-Output "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          
          $startTime = Get-Date
          
          .\scripts\tiny11maker-headless.ps1 @params
          
          $buildTime = (Get-Date) - $startTime
          Write-Output "Build completed in $($buildTime.TotalMinutes.ToString('F2')) minutes"
          
      - name: Verify tiny11 ISO creation
        shell: powershell
        run: |
          $tempIso = ".\scripts\tiny11.iso"
          $isoName = "${{ env.ISO_FILENAME }}"

          # Check if ISO was created
          if (-not (Test-Path $tempIso)) {
            Write-Error "$tempIso was not created!"
            Write-Output "Contents of current directory:"
            Get-ChildItem -Path . | Format-Table Name, Length, LastWriteTime
            exit 1
          }

          # Rename to proper filename
          Move-Item -Path $tempIso -Destination $isoName -Force
          Write-Output "ISO renamed to: $isoName"

          $sizeGB = [math]::Round((Get-Item $isoName).Length / 1GB, 2)
          Write-Output "$isoName created successfully: ${sizeGB}GB"

          # Generate checksums
          Write-Output "Generating checksums..."
          $sha256 = (Get-FileHash -Path $isoName -Algorithm SHA256).Hash
          $md5 = (Get-FileHash -Path $isoName -Algorithm MD5).Hash

          # Save checksums to files
          "$sha256  $isoName" | Out-File -FilePath "$isoName.sha256" -Encoding ASCII
          "$md5  $isoName" | Out-File -FilePath "$isoName.md5" -Encoding ASCII

          # Create verification file with all info
          $verificationInfo = @"
          Tiny11 ISO Verification
          ========================
          File: $isoName
          Size: ${sizeGB}GB
          Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          Image Index: ${{ github.event.inputs.image_index }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          SHA256: $sha256
          MD5: $md5

          To verify:
            certutil -hashfile $isoName SHA256
            certutil -hashfile $isoName MD5
          "@

          $verificationInfo | Out-File -FilePath "$isoName.txt" -Encoding UTF8

          # Persist values for later steps
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_NAME=$isoName"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_SIZE_GB=$sizeGB"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_SHA256=$sha256"
          Add-Content -Path $env:GITHUB_ENV -Value "ISO_MD5=$md5"
          
      - name: Cleanup before upload
        shell: powershell
        run: |
          Write-Output "Cleaning up to free disk space..."
          
          # Unmount ISO
          $isoPath = Join-Path $PWD "Win11_Source.iso"
          if (Test-Path $isoPath) {
            Get-DiskImage -ImagePath $isoPath | Dismount-DiskImage -ErrorAction SilentlyContinue
            Write-Output "ISO unmounted"
          }
          
          # Remove source ISO
          Remove-Item "Win11_Source.iso" -Force -ErrorAction SilentlyContinue
          
          # Remove build logs if they're large
          Get-ChildItem -Path . -Filter "*.log" | Where-Object { $_.Length -gt 10MB } | Remove-Item -Force
          
          $disk = Get-PSDrive C
          $freeGB = [math]::Round($disk.Free / 1GB, 2)
          Write-Output "Available space after cleanup: ${freeGB}GB"

      - name: Check upload configuration
        id: check-upload
        shell: powershell
        env:
          SF_KEY: ${{ secrets.SF_SSH_KEY }}
          ENABLE_UPLOAD: ${{ vars.ENABLE_SOURCEFORGE_UPLOAD }}
        run: |
          if ($env:ENABLE_UPLOAD -eq 'true' -or -not [string]::IsNullOrWhiteSpace($env:SF_KEY)) {
            Write-Output "Upload condition met."
            "DO_UPLOAD=true" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          } else {
            Write-Output "Upload condition NOT met. Fallback to artifacts."
            "DO_UPLOAD=false" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          }

      - name: Validate SourceForge credentials
        if: env.DO_UPLOAD == 'true'
        env:
          SF_SSH_KEY: ${{ secrets.SF_SSH_KEY }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        shell: powershell
        run: |
          if ([string]::IsNullOrWhiteSpace($env:SF_SSH_KEY)) {
            Write-Error "SF_SSH_KEY secret is not configured"
            exit 1
          }
          if ([string]::IsNullOrWhiteSpace($env:SF_USERNAME)) {
            Write-Error "SF_USERNAME secret is not configured"
            exit 1
          }
          
          Write-Output "Credentials validated successfully"
          
      - name: Setup SSH for SourceForge
        if: env.DO_UPLOAD == 'true'
        shell: powershell
        env:
          SF_PROJECT: ${{ secrets.SF_PROJECT }}
          SF_SSH_KEY: ${{ secrets.SF_SSH_KEY }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          # 1. Validation
          if ([string]::IsNullOrWhiteSpace($env:SF_SSH_KEY)) { Write-Error "Secret SF_SSH_KEY is missing"; exit 1 }
          
          # Fallback for Project Name
          if ([string]::IsNullOrWhiteSpace($env:SF_PROJECT)) {
            $env:SF_PROJECT = "${{ github.event.repository.name }}"
          }
          Add-Content -Path $env:GITHUB_ENV -Value "SF_PROJECT=$env:SF_PROJECT"
          
          # 2. Create SSH Directory
          $sshDir = "$env:USERPROFILE\.ssh"
          if (!(Test-Path $sshDir)) { New-Item -ItemType Directory -Force -Path $sshDir | Out-Null }
          
          $keyPath = "$sshDir\sf_key"
          
          # 3. Write Private Key (BASE64 DECODE FIX)
          # We decode the base64 secret back into a raw file. 
          # This creates a perfect file byte-for-byte, fixing the "Invalid Format" error.
          try {
            $keyBytes = [System.Convert]::FromBase64String($env:SF_SSH_KEY)
            [System.IO.File]::WriteAllBytes($keyPath, $keyBytes)
          } catch {
            Write-Error "Failed to decode SF_SSH_KEY. Did you Base64 encode it in Termux first?"
            exit 1
          }
          
          # 4. Fix Permissions (Windows ACLs)
          # OpenSSH on Windows refuses keys that are too "open".
          icacls $keyPath /c /t /inheritance:d
          icacls $keyPath /c /t /grant "${env:USERNAME}:F"
          icacls $keyPath /c /t /remove Administrator "Authenticated Users" BUILTIN\Administrators BUILTIN\Users
          
          # 5. Add Known Host
          ssh-keyscan -t rsa,ecdsa,ed25519 frs.sourceforge.net | Out-File -FilePath "$sshDir\known_hosts" -Encoding ascii
          
          Write-Output "SSH configuration complete."

      - name: Upload to SourceForge (Recursive Method)
        if: env.DO_UPLOAD == 'true'
        shell: powershell
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PROJECT: ${{ secrets.SF_PROJECT }}
          ISO_NAME: ${{ env.ISO_NAME }}
          RELEASE_TAG: ${{ env.RELEASE_TAG }}
        run: |
          $keyPath = "$env:USERPROFILE\.ssh\sf_key"

          # 1. Prepare a local folder
          # We create a folder locally named after the edition and version (e.g., "Tiny11-HOME-25H2")
          Write-Output "Organizing files into folder: $env:FOLDER_NAME"
          New-Item -ItemType Directory -Force -Path $env:FOLDER_NAME | Out-Null

          # 2. Copy files into this folder
          # Note: Using Copy-Item instead of Move-Item so files remain for the GitHub Release step below
          Copy-Item $env:ISO_NAME $env:FOLDER_NAME
          Copy-Item "$env:ISO_NAME.sha256" $env:FOLDER_NAME
          Copy-Item "$env:ISO_NAME.md5" $env:FOLDER_NAME
          Copy-Item "$env:ISO_NAME.txt" $env:FOLDER_NAME

          # Copy SourceForge README
          if (Test-Path "SOURCEFORGE_README.md") {
            Copy-Item "SOURCEFORGE_README.md" $env:FOLDER_NAME
            Write-Output "Copied SOURCEFORGE_README.md to folder"
          }

          # 3. Upload the WHOLE folder
          # The '-r' flag tells SCP to copy the folder.
          # SCP will automatically create the directory on SourceForge if it doesn't exist.
          $remoteRoot = "$env:SF_USERNAME@frs.sourceforge.net:/home/frs/project/$env:SF_PROJECT/"

          Write-Output "Uploading folder..."
          scp -i $keyPath -r -o StrictHostKeyChecking=no $env:FOLDER_NAME $remoteRoot

          if ($LASTEXITCODE -ne 0) {
            Write-Error "SCP Upload failed"
            exit 1
          }
          Write-Output "Upload success!"

          # 4. Set Download URL
          $downloadUrl = "https://sourceforge.net/projects/$env:SF_PROJECT/files/$env:FOLDER_NAME/$env:ISO_NAME/download"
          Add-Content -Path $env:GITHUB_ENV -Value "SF_DOWNLOAD_URL=$downloadUrl"
          
      - name: Cleanup SSH credentials
        if: always()
        shell: powershell
        run: |
          $keyPath = "$env:USERPROFILE\.ssh\sf_key"
          if (Test-Path $keyPath) {
            Remove-Item $keyPath -Force -ErrorAction SilentlyContinue
            Write-Output "SSH key cleaned up"
          }
          
      - name: Upload ISO as artifact (fallback)
        if: env.DO_UPLOAD != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: |
            ${{ env.ISO_NAME }}
            ${{ env.ISO_NAME }}.sha256
            ${{ env.ISO_NAME }}.md5
            ${{ env.ISO_NAME }}.txt
          retention-days: 7
          compression-level: 0

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Tiny11 Windows 11 ${{ github.event.inputs.windows_version }} - ${{ env.RELEASE_TAG }}
          body: |
            ## üöÄ Tiny11 Windows 11 ${{ github.event.inputs.windows_version }} Build

            **Automated build by kelexine's workflow**

            ### üì¶ Build Information
            - **Built with:** [tiny11builder](https://github.com/ntdevlabs/tiny11builder) by ntdevlabs
            - **Modified by:** [kelexine](https://github.com/kelexine)
            - **Build Date:** ${{ github.event.repository.updated_at }}
            - **Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### üì• Download
            ${{ secrets.SF_SSH_KEY != '' && format('**SourceForge:** [{0}]({1})', env.ISO_NAME, env.SF_DOWNLOAD_URL) || '**GitHub Artifacts:** Check workflow run for download' }}

            ### üíø Image Details
            | Property | Value |
            |----------|-------|
            | **File** | ${{ env.ISO_NAME }} |
            | **Size** | ${{ env.ISO_SIZE_GB }}GB |
            | **Type** | Standard (Serviceable) |
            | **Base** | Windows 11 ${{ github.event.inputs.windows_version }} |
            | **Index** | ${{ github.event.inputs.image_index }} |
            | **Language** | ${{ github.event.inputs.language }} |

            ### üîí Checksums

            **SHA256:**
            ```
            ${{ env.ISO_SHA256 }}
            ```

            **MD5:**
            ```
            ${{ env.ISO_MD5 }}
            ```

            ### ‚ùå What's Removed
            - Microsoft Edge, EdgeWebView, Edge Update
            - OneDrive
            - Xbox apps and Game Bar
            - Teams, Copilot, Chat
            - Sponsored apps and suggestions
            - Telemetry and diagnostics
            - Bloatware (Clipchamp, News, Weather, etc.)

            ### ‚úÖ Features
            - ‚úÖ Fully serviceable - Can add languages, updates, features
            - ‚úÖ Bypasses TPM 2.0, Secure Boot, CPU, RAM requirements
            - ‚úÖ Local account support on OOBE
            - ‚úÖ Disabled telemetry and tracking
            - ‚úÖ Compact installation (~3-5GB)
            - ‚úÖ Faster boot and performance

            ### üìã Windows Editions
            | Index | Edition |
            |-------|---------|
            | 1 | Home |
            | 4 | Education |
            | 6 | Pro |
            | 7 | Pro N |

            ---

            **‚ö†Ô∏è Disclaimer:** This is an unofficial Windows 11 modification. Use at your own risk. Not affiliated with Microsoft.

            **üìú License:** Educational purposes only. Requires valid Windows license from Microsoft.
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            ${{ env.ISO_NAME }}.sha256
            ${{ env.ISO_NAME }}.md5
            ${{ env.ISO_NAME }}.txt
          
      - name: Workflow summary
        shell: powershell
        run: |
          $summary = @"
          # ‚úÖ Tiny11 Build Completed Successfully

          ## üì¶ Build Information
          - **ISO:** $env:ISO_NAME
          - **Size:** $env:ISO_SIZE_GB GB
          - **Release:** ${{ env.RELEASE_TAG }}
          - **Version:** ${{ github.event.inputs.windows_version }}
          - **Language:** ${{ github.event.inputs.language }}
          - **Image Index:** ${{ github.event.inputs.image_index }}

          ## üì• Download
          ${{ secrets.SF_SSH_KEY != '' && format('üîó **SourceForge:** [{0}]({1})', env.ISO_NAME, env.SF_DOWNLOAD_URL) || 'üîó **GitHub Artifacts:** Available in workflow run' }}

          ## üîí Checksums
          **SHA256:** ``````
          $env:ISO_SHA256
          ``````

          **MD5:** ``````
          $env:ISO_MD5
          ``````

          ## ‚è±Ô∏è Build Time
          Completed at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

          ---
          Built by [kelexine](https://github.com/kelexine) | Original by [ntdevlabs](https://github.com/ntdevlabs)
          "@

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
